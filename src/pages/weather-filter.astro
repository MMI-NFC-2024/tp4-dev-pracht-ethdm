---
import Layout from "../layouts/Layout.astro";
---
<Layout>
  <main>
    <h2>Météo – Filtres interactifs</h2>
    <div>
      <label for="location">Ville :</label>
      <select id="location"><option value="">Toutes</option></select>

      <label for="weather">Type :</label>
      <select id="weather">
        <option value="">Tous</option>
        <option value="sun">Soleil</option>
        <option value="rain">Pluie</option>
        <option value="snow">Neige</option>
        <option value="fog">Brouillard</option>
      </select>

      <label for="minTemp">Temp. min :</label>
      <input type="number" id="minTemp" placeholder="°C" />

      <label for="maxTemp">Temp. max :</label>
      <input type="number" id="maxTemp" placeholder="°C" />
    </div>

    <div id="plot"></div>
  </main>

  <script type="module">
    import * as Plot from "@observablehq/plot";
    import weather from "../assets/weather.json";

    const $ = id => document.getElementById(id);
    const plotDiv = $("plot");

    const locations = [...new Set(weather.map(d => d.location))];
    for (const loc of locations) {
      const opt = document.createElement("option");
      opt.value = loc;
      opt.textContent = loc;
      $("location").appendChild(opt);
    }

    function render() {
      let data = weather;
      if ($("location").value) data = data.filter(d => d.location === $("location").value);
      if ($("weather").value) data = data.filter(d => d.weather === $("weather").value);
      if ($("minTemp").value) data = data.filter(d => d.temp_min >= +$("minTemp").value);
      if ($("maxTemp").value) data = data.filter(d => d.temp_max <= +$("maxTemp").value);

      plotDiv.innerHTML = "";
      if (!data.length) return plotDiv.innerHTML = "<p>Aucune donnée.</p>";

      const plot = Plot.plot({
        marks: [
          Plot.line(data, { x: d => new Date(d.date), y: "temp_max", stroke: "location" }),
          Plot.line(data, { x: d => new Date(d.date), y: "temp_min", stroke: "location", strokeDasharray: "4 2" }),
          Plot.dot(data, { x: d => new Date(d.date), y: "temp_max", fill: "weather", r: 3 })
        ],
        x: { label: "Date", type: "utc" },
        y: { label: "Température (°C)" },
        width: 800,
        height: 400
      });

      plotDiv.appendChild(plot);
    }

    ["location", "weather", "minTemp", "maxTemp"].forEach(id => $(id).addEventListener("input", render));
    render();
  </script>
</Layout>
